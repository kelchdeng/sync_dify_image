name: Sync GraphDB Image to Alibaba Cloud ACR

on:
  workflow_dispatch:
    inputs:
      graphdb_version:
        description: 'GraphDB version to sync'
        required: true
        default: '10.6.2-free'
        type: string

jobs:
  sync-graphdb-image:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code (optional, only for logging/auditing)
      uses: actions/checkout@v3

    - name: Log in to Alibaba Cloud ACR
      run: |
        echo "${{ secrets.ACR_PASSWORD }}" | docker login \
          ${{ secrets.ACR_REGISTRY }} \
          --username ${{ secrets.ACR_USERNAME }} \
          --password-stdin

    - name: Pull and push GraphDB image to Alibaba Cloud ACR
      run: |
        # 设置变量
        SOURCE_IMAGE="ontotext/graphdb:${{ github.event.inputs.graphdb_version }}"
        ACR_REGISTRY="${{ secrets.ACR_REGISTRY }}"
        
        echo "Source Image: $SOURCE_IMAGE"
        echo "ACR Registry: $ACR_REGISTRY"
        
        # 拉取镜像
        echo "Pulling image from DockerHub..."
        docker pull $SOURCE_IMAGE
        
        # 定义目标镜像名称
        # 这里你可以选择保持原名或修改
        TARGET_IMAGE="$ACR_REGISTRY/kelch/graphdb:${{ github.event.inputs.graphdb_version }}"
        echo "Target Image: $TARGET_IMAGE"
        
        # 标记镜像
        echo "Tagging image..."
        docker tag $SOURCE_IMAGE $TARGET_IMAGE
        
        # 推送到ACR
        echo "Pushing image to ACR..."
        docker push $TARGET_IMAGE
        
        # 清理原始镜像（可选）
        echo "Cleaning up local images..."
        docker rmi $SOURCE_IMAGE
        docker rmi $TARGET_IMAGE
        
        echo "mage sync completed!"
        
    - name: Verify pushed image
      run: |
        # 验证镜像已成功推送
        TARGET_IMAGE="${{ secrets.ACR_REGISTRY }}/kelch/graphdb:${{ github.event.inputs.graphdb_version }}"
        echo "Verifying image: $TARGET_IMAGE"
        docker pull $TARGET_IMAGE
        echo "mage verification successful!"
        docker rmi $TARGET_IMAGE
